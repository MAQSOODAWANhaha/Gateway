# 设计文档

## 目标
- 提供统一的代理管理 Web UI 与 API。
- 支持端口代理、路径代理、WS 代理与灵活匹配。
- 分布式数据平面，配置一致下发与回滚。
- 支持 TLS 与 ACME 自动签发/续期。

## 非目标（第一阶段）
- 外部身份系统接入（SSO/OAuth/LDAP）。
- 多租户计费与限流。

## 架构概览

### 控制平面（control-plane）
- REST API + Web UI 用于配置与运维。
- Postgres 保存配置、版本、审计、节点状态。
- 配置发布器生成不可变快照并发布。
- ACME 证书管理（自动签发/续期）。
- 内置轻量控制台（`/`）用于基础可视化与跳转。

### Web 前端（web/）
- React + Vite + Tailwind + shadcn/ui。
- 主题切换（Light/Dark，高对比可选）。
- 与控制平面同域静态托管，避免 CORS。

## Web 设计规范摘要
- 风格：参考 Nginx Proxy Manager 的高密度后台风格（卡片状态条 + 强对比分割线）。
- 色彩：保留蓝紫主色，增加青色与橙色辅助，层级更清晰。
- 主题：Light / Dark，High-Contrast 可选。
- 字体：统一使用 Noto Sans SC。
- 背景：低饱和径向渐变，卡片状态条增强信息层级。
- 导航：桌面侧栏可折叠，移动端抽屉式侧栏，图标底色增强识别。
- 规范详见：docs/web-style.md。
### 数据平面（data-plane）
- 基于 Pingora 的高性能代理节点。
- 本地路由表（由发布快照生成）。
- 上游健康检查与负载均衡。
- TLS 证书热更新。

## 配置生命周期
1) 用户创建或编辑配置草稿（监听器、路由、上游、TLS 策略）。
2) 发布前进行冲突与有效性校验（端口唯一、协议合法、HTTPS 必须绑定 TLS、路由类型与匹配规则、上游地址格式）。
3) 生成快照并发布为新版本。
4) 数据平面轮询最新版本并拉取快照。
5) 节点原子更新路由配置，保持存量连接。

## 路由规则
- 匹配条件：Host、Path（前缀/正则）、Method、Header、Query、WS Upgrade。
- 优先级：优先级数字越大越优先；并在发布时做冲突检测。

## TLS 与 ACME
- 支持 HTTP-01 自动签发与续期。
- 证书保存在数据库中，并在数据平面生成本地证书文件。
- 证书热加载，不应中断现有 WS 连接。
- 目前仅实现 HTTP-01；TLS-ALPN-01 / DNS-01 计划中。

## 分布式部署
- 节点注册与心跳。
- 节点版本可视化与一致性检查。
- 支持滚动发布与回滚。

## 可观测性
- 指标：QPS、延迟、错误率、活跃连接、上游健康。
- 日志：访问日志、错误日志、审计日志。
- 导出：Prometheus metrics。

## 当前实现限制
- 未启用端口段预绑定时：监听器新增/删除需要重启数据平面。
- 启用端口段预绑定（`HTTP_PORT_RANGE`/`HTTPS_PORT_RANGE`）时：可在端口范围内动态新增/启用监听器，无需重启数据平面。
- 仅支持 HTTP-01 ACME，DNS-01/TLS-ALPN-01 待实现。
